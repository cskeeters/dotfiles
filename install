#!/bin/bash

function die()
{
    echo "${@}"
    exit 1
}

function erun()
{
  echo "Running: ${@}"
  ${@} || die "Error running ${@}"
}

cd ~
if [ ! -e dotfiles ]; then
  hg clone -u tip ssh://hg@bitbucket.org/cskeeters/dotfiles
  else 
  cd dotfiles
  hg pull -u
  cd ~
fi

#date=$(date +"%m_%d_%Y")

if [ ! -e dotfiles/backup ]; then
  mkdir dotfiles/backup
fi

for dotfile in `find dotfiles -type f -name ".*" | cut -c10-99`
do
  if [[ "$dotfile" != .hg/* ]]; then
    if [[ "$dotfile" != *backup* ]]; then
      if [ -L $dotfile ]; then
        erun rm $dotfile
      else
        if [ -f $dotfile ]; then
          erun mv $dotfile dotfiles/backup
        fi
      fi
      erun ln -s dotfiles/$dotfile $dotfile
    fi
  fi
done

echo "Installing zshuery"
if [[ -d ~/.zshuery ]]; then
  echo Already installed. Update with:
  echo "cd ~/.zshuery; git pull"
else
  git clone https://github.com/myfreeweb/zshuery.git ~/.zshuery
fi
echo

echo "Run this to fix escape character delay in vim"
echo "mv /etc/vimrc /etc/vimrc.disabled"
echo

echo "Setup reStructuredText"
echo "mv ~/.rst2pdf backup/"
echo "ln -s ~/dotfiles/.rst2pdf ~/.rst2pdf"
echo "mv ~/.rst2html backup/"
echo "ln -s ~/dotfiles/.rst2html ~/.rst2html"
echo

echo "Setup vundle for vim"
echo "git clone https://github.com/gmarik/vundle.git ~/.vim/bundle/vundle"
echo "vim +BundleInstall +q +q"
echo

echo "Setup iterm settings"
echo "plutil -convert binary1 ~/dotfiles/iterm2.xml -o ~/Library/Preferences/com.googlecode.iterm2.plist"
echo "Backup: plutil -convert xml1 ~/Library/Preferences/com.googlecode.iterm2.plist -o ~/dotfiles/iterm2.xml"
